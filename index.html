<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5F5F3">
    <meta name="description" content="New Roots - A multiplayer interactive story game about starting a new life in Canada">
    <title>New Roots - Multiplayer Game</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- PeerJS for multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- QRCode.js for QR code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #F5F5F3;
            --surface: #FFFFFF;
            --accent: #CC785C;
            --accent-dark: #B86F54;
            --accent-glow: rgba(204, 120, 92, 0.35);
            --p1: #3B82F6;
            --p1-glow: rgba(59,130,246,0.3);
            --p1-bg: rgba(59,130,246,0.06);
            --p2: #8B5CF6;
            --p2-glow: rgba(139,92,246,0.3);
            --p2-bg: rgba(139,92,246,0.06);
            --text: #1F1F1F;
            --text-light: #666666;
            --border: #E5E5E0;
            --success: #2D7B6B;
            --warning: #D97706;
            --error: #C2410C;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 24px;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            background: var(--surface);
            border-radius: 16px;
            padding: 28px 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; flex-shrink: 0;
        }
        .game-title { font-size: 28px; font-weight: 600; letter-spacing: -0.5px; }
        .chapter-info { color: var(--text-light); font-size: 14px; }

        /* Connection Status */
        .connection-status {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 14px; border-radius: 8px;
            font-size: 13px; font-weight: 600;
            background: var(--p1-bg); color: var(--p1);
        }
        .connection-status.host { background: var(--p2-bg); color: var(--p2); }
        .connection-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: currentColor; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Menu Screen */
        .menu-screen {
            min-height: 70vh;
            display: flex; align-items: center; justify-content: center;
        }
        .menu-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 48px;
            max-width: 480px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .menu-icon { font-size: 64px; margin-bottom: 20px; }
        .menu-title { font-size: 32px; font-weight: 700; margin-bottom: 12px; }
        .menu-subtitle { color: var(--text-light); margin-bottom: 32px; }
        .menu-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 16px;
            font-family: inherit;
        }
        .menu-input:focus { outline: none; border-color: var(--accent); }
        .menu-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            font-family: inherit;
            margin: 8px 0;
        }
        .menu-btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
        }
        .menu-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--accent-glow);
        }
        .menu-btn-secondary {
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text);
        }
        .menu-btn-secondary:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        /* Lobby Screen */
        .lobby-qr-container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border: 2px solid var(--border);
            margin: 24px auto;
            display: inline-block;
            box-shadow: var(--shadow-md);
        }
        .lobby-qr-container #qrcode {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lobby-url {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            word-break: break-all;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
        }
        .lobby-id {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
        }
        .lobby-players {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 24px 0;
        }
        .lobby-player {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .lobby-player.connected {
            background: var(--p1-bg);
            border: 2px solid var(--p1);
        }
        .lobby-player-icon { font-size: 32px; margin-bottom: 8px; }
        .lobby-player-name { font-weight: 600; }
        .lobby-player-status {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* QR Share Button */
        .share-btn {
            width: 44px; height: 44px; border-radius: 12px;
            background: var(--surface); border: 2px solid var(--border);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.25s ease; flex-shrink: 0;
            font-size: 20px;
        }
        .share-btn:hover { border-color: var(--accent); box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .share-btn:active { transform: scale(0.95); }

        /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
        .progress-bar {
            background: var(--border); height: 8px; border-radius: 4px;
            margin-bottom: 20px; overflow: hidden;
        }
        .progress-fill {
            background: linear-gradient(90deg, var(--accent), var(--accent-dark));
            height: 100%; transition: width 0.5s ease;
        }

        /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }
        .stat-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px; box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        .stat-card.flash { animation: statFlash 0.6s ease; }
        @keyframes statFlash {
            0%,100% { background: var(--surface); }
            50% { background: rgba(204,120,92,0.12); }
        }
        .stat-header { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .stat-icon { font-size: 14px; }
        .stat-label {
            font-size: 11px; font-weight: 600; color: var(--text-light);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .stat-value { font-size: 24px; font-weight: 600; margin-bottom: 6px; transition: color 0.3s; }
        .stat-bar { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .stat-bar-fill {
            height: 100%; border-radius: 3px;
            transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
        }
        .stat-bar-fill.relationship { background: var(--accent); }
        .stat-bar-fill.trust { background: var(--success); }
        .stat-bar-fill.stress { background: var(--warning); }

        /* ‚îÄ‚îÄ Instructions (collapsible on mobile) ‚îÄ‚îÄ */
        .instructions {
            background: linear-gradient(135deg, rgba(204,120,92,0.05), rgba(204,120,92,0.02));
            border: 1px solid var(--border); border-radius: 12px;
            padding: 16px 20px; margin-bottom: 20px;
        }
        .instructions-toggle {
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none;
        }
        .instructions-title { font-size: 15px; font-weight: 600; }
        .instructions-arrow { transition: transform 0.3s; font-size: 12px; color: var(--text-light); }
        .instructions-arrow.open { transform: rotate(180deg); }
        .instructions-body { overflow: hidden; transition: max-height 0.3s ease; }
        .instructions-list { color: var(--text-light); font-size: 13px; line-height: 1.6; padding-top: 12px; }
        .instructions-list li { margin-left: 20px; margin-bottom: 4px; }

        /* ‚îÄ‚îÄ Episode Nav ‚îÄ‚îÄ */
        .episode-nav {
            display: flex; gap: 6px; margin-bottom: 20px;
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; padding-bottom: 4px;
        }
        .episode-nav::-webkit-scrollbar { display: none; }
        .episode-tab {
            padding: 10px 14px; background: var(--surface);
            border: 2px solid var(--border); border-radius: 10px;
            cursor: pointer; transition: all 0.25s ease; text-align: center;
            user-select: none; flex-shrink: 0; min-width: 80px;
        }
        .episode-tab:hover:not(.locked) {
            border-color: var(--accent); transform: translateY(-2px);
        }
        .episode-tab:active:not(.locked) { transform: translateY(0); }
        .episode-tab.active {
            border-color: var(--accent);
            background: linear-gradient(to bottom, rgba(204,120,92,0.08), transparent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .episode-tab.locked { opacity: 0.4; cursor: not-allowed; }
        .episode-tab.completed { border-color: var(--success); }
        .episode-tab.completed::after { content: ' ‚úì'; color: var(--success); font-weight: 700; }
        .episode-tab-number {
            font-size: 10px; font-weight: 700; color: var(--text-light);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .episode-tab-title { font-size: 12px; font-weight: 600; }

        /* ‚îÄ‚îÄ Episode Card ‚îÄ‚îÄ */
        .episode-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px; margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            animation: fadeSlideIn 0.4s ease;
        }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .episode-header {
            display: flex; align-items: center; gap: 12px;
            padding-bottom: 16px; margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .episode-number {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white; width: 34px; height: 34px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 15px; flex-shrink: 0;
        }
        .episode-title { font-size: 22px; font-weight: 600; }

        /* ‚îÄ‚îÄ Scenario ‚îÄ‚îÄ */
        .scenario-content {
            background: #FAFAF8; border-radius: 12px; padding: 20px;
            margin-bottom: 20px; border-left: 3px solid var(--accent);
        }
        .scenario-location {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 10px;
        }
        .scenario-text { font-size: 15px; line-height: 1.7; }

        /* ‚îÄ‚îÄ Player Section ‚îÄ‚îÄ */
        .player-section { margin-bottom: 20px; transition: all 0.3s ease; }
        .player-section.my-turn {
            box-shadow: 0 0 0 3px var(--accent-glow);
            border-radius: 12px;
        }
        .player-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
        .player-avatar {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #E5E5E0, #D5D5D0);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .player-section.p1-section .player-avatar { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1)); }
        .player-section.p2-section .player-avatar { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.1)); }
        .player-name { font-size: 15px; font-weight: 600; }
        .player-name.p1 { color: var(--p1); }
        .player-name.p2 { color: var(--p2); }
        .player-status {
            background: #FAFAF8; border-left: 3px solid var(--border);
            padding: 10px 14px; border-radius: 8px;
            font-size: 13px; color: var(--text-light); margin-bottom: 14px;
            transition: all 0.3s ease;
        }
        .player-status.chosen {
            border-left-color: var(--success);
            background: rgba(45,123,107,0.05);
            color: var(--success);
        }

        /* ‚îÄ‚îÄ Choice Cards ‚îÄ‚îÄ */
        .choices-grid { display: grid; gap: 10px; }
        .choice-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px; padding: 16px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            position: relative; overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .choice-card .ripple {
            position: absolute; border-radius: 50%;
            background: rgba(204,120,92,0.25);
            transform: scale(0); animation: rippleAnim 0.6s ease-out;
            pointer-events: none;
        }
        @keyframes rippleAnim { to { transform: scale(4); opacity: 0; } }
        .choice-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(204,120,92,0.15);
            transform: translateY(-3px);
        }
        .choice-card:active { transform: translateY(-1px) scale(0.98); }
        .choice-card.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(204,120,92,0.06), rgba(204,120,92,0.02));
            box-shadow: 0 0 0 3px var(--accent-glow), 0 4px 16px rgba(204,120,92,0.15);
            animation: selectPop 0.35s cubic-bezier(0.34,1.56,0.64,1);
        }
        @keyframes selectPop {
            0% { transform: scale(0.97); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .choice-card.selected::before {
            content: '‚úì';
            position: absolute; top: 10px; right: 10px;
            width: 26px; height: 26px; border-radius: 50%;
            background: var(--accent); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700;
            animation: checkPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
            box-shadow: 0 2px 8px rgba(204,120,92,0.4);
        }
        @keyframes checkPop { from { transform: scale(0); } to { transform: scale(1); } }
        .choice-header {
            display: flex; align-items: flex-start; justify-content: space-between;
            margin-bottom: 10px; padding-right: 30px;
        }
        .choice-title {
            font-size: 15px; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
        }
        .choice-cost {
            background: var(--text); color: white;
            padding: 3px 10px; border-radius: 6px;
            font-size: 13px; font-weight: 600; white-space: nowrap;
        }
        .choice-details { display: grid; gap: 4px; }
        .choice-detail {
            font-size: 13px; line-height: 1.5;
            display: flex; align-items: flex-start; gap: 5px;
        }
        .choice-detail.pro { color: var(--success); }
        .choice-detail.con { color: var(--error); }
        .choice-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ‚îÄ‚îÄ Lock Button ‚îÄ‚îÄ */
        .lock-btn-container { text-align: center; padding-top: 8px; }
        .btn {
            padding: 14px 28px; border-radius: 10px; font-size: 15px;
            font-weight: 600; cursor: pointer; border: none;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            font-family: inherit; user-select: none;
            position: relative; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover:not(:disabled) {
            background: var(--accent-dark);
            box-shadow: 0 4px 16px rgba(204,120,92,0.35);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: var(--surface); color: var(--text);
            border: 2px solid var(--border);
        }
        .btn-secondary:hover { border-color: var(--accent); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:disabled:hover { transform: none; box-shadow: none; }
        .btn-lg { padding: 16px 32px; font-size: 16px; border-radius: 12px; }
        .button-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
        .negotiation-panel {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border: 2px solid var(--warning); border-radius: 16px;
            padding: 28px; margin: 20px 0; display: none;
        }
        .negotiation-panel.active { display: block; animation: fadeSlideIn 0.4s ease; }
        .negotiation-header { text-align: center; margin-bottom: 20px; }
        .negotiation-title { font-size: 20px; font-weight: 600; margin-bottom: 6px; }
        .timer-display {
            font-size: 52px; font-weight: 700; color: var(--warning);
            text-align: center; margin: 20px 0;
            font-variant-numeric: tabular-nums; transition: color 0.3s;
        }
        .timer-display.critical { color: var(--error); animation: timerPulse 1s infinite; }
        @keyframes timerPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        .dialogue-grid { display: grid; gap: 10px; margin-top: 16px; }
        .dialogue-option {
            background: white; border: 2px solid var(--border);
            border-radius: 10px; padding: 14px; cursor: pointer;
            transition: all 0.25s ease; font-size: 14px; line-height: 1.5;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .dialogue-option:hover {
            border-color: var(--warning);
            box-shadow: 0 4px 12px rgba(217,119,6,0.15);
            transform: translateY(-2px);
        }
        .dialogue-option:active { transform: translateY(0) scale(0.99); }

        .comparison-panel {
            background: var(--surface); border: 2px solid var(--border);
            border-radius: 16px; padding: 28px; margin: 20px 0; display: none;
        }
        .comparison-panel.active { display: block; animation: fadeSlideIn 0.4s ease; }
        .comparison-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; margin: 20px 0;
        }
        .comparison-item { text-align: center; }
        .comparison-choice { font-size: 16px; font-weight: 600; margin-top: 10px; }
        .match-status {
            text-align: center; font-size: 16px; font-weight: 600;
            padding: 14px; border-radius: 10px; margin-top: 14px;
        }
        .match-status.success { background: rgba(45,123,107,0.1); color: var(--success); }
        .match-status.warning { background: rgba(217,119,6,0.1); color: var(--warning); }

        .outcome-panel {
            background: var(--surface); border: 2px solid var(--border);
            border-radius: 16px; padding: 28px; margin: 20px 0; display: none;
        }
        .outcome-panel.active { display: block; animation: fadeSlideIn 0.4s ease; }
        .outcome-header { text-align: center; margin-bottom: 20px; }
        .outcome-title { font-size: 24px; font-weight: 600; margin-bottom: 10px; }
        .outcome-description {
            font-size: 15px; line-height: 1.7;
            background: #FAFAF8; padding: 18px; border-radius: 10px; margin-bottom: 20px;
        }
        .effects-grid { display: grid; gap: 8px; margin-bottom: 20px; }
        .effect-item {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px; border-radius: 8px; font-size: 14px;
            animation: effectSlideIn 0.4s ease backwards;
        }
        .effect-item:nth-child(1) { animation-delay: 0.1s; }
        .effect-item:nth-child(2) { animation-delay: 0.2s; }
        .effect-item:nth-child(3) { animation-delay: 0.3s; }
        .effect-item:nth-child(4) { animation-delay: 0.4s; }
        @keyframes effectSlideIn {
            from { opacity: 0; transform: translateX(-12px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .effect-item.positive { background: rgba(45,123,107,0.1); color: var(--success); }
        .effect-item.negative { background: rgba(194,65,12,0.1); color: var(--error); }
        .effect-item.neutral { background: rgba(217,119,6,0.1); color: var(--warning); }

        /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease; padding: 20px;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal {
            background: var(--surface); border-radius: 20px;
            padding: 36px; max-width: 520px; width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal h2 { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 6px; }
        .modal .subtitle { text-align: center; color: var(--text-light); margin-bottom: 24px; font-size: 14px; }
        .final-stat {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .final-stat:last-of-type { border-bottom: none; }
        .final-stat-label { font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .final-stat-value { font-size: 18px; font-weight: 700; }
        .final-badge {
            display: inline-block; padding: 3px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 600; margin-left: 6px;
        }
        .badge-great { background: rgba(45,123,107,0.15); color: var(--success); }
        .badge-ok { background: rgba(217,119,6,0.15); color: var(--warning); }
        .badge-bad { background: rgba(194,65,12,0.15); color: var(--error); }
        .modal .btn { margin-top: 20px; width: 100%; }
        .chapter-preview {
            margin-top: 20px; padding: 14px; background: #FAFAF8;
            border-radius: 10px; font-size: 13px; color: var(--text-light); line-height: 1.7;
        }

        .hidden { display: none !important; }

        /* Desktop: side-by-side players */
        @media (min-width: 701px) {
            .players-wrapper {
                display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
            }
        }

        /* Mobile */
        @media (max-width: 700px) {
            body { padding: 12px; }
            .header { padding: 16px 18px; border-radius: 12px; }
            .game-title { font-size: 22px; }
            .chapter-info { font-size: 12px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; }
            .stat-card { padding: 12px; }
            .stat-value { font-size: 20px; }
            .episode-card { padding: 18px; border-radius: 12px; }
            .episode-title { font-size: 18px; }
            .scenario-content { padding: 16px; }
            .scenario-text { font-size: 14px; }
            .choice-card { padding: 14px; }
            .choice-title { font-size: 14px; }
            .choice-detail { font-size: 12px; }
            .negotiation-panel, .comparison-panel, .outcome-panel { padding: 20px; }
            .timer-display { font-size: 44px; }
            .modal { padding: 24px; border-radius: 16px; }
            .menu-card { padding: 32px; }
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <!-- Final Summary Modal -->
    <div class="modal-overlay" id="final-modal">
        <div class="modal" id="final-modal-content"></div>
    </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO ‚Äî Web Audio API sounds
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AudioCtxClass = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function ensureAudio() { if (!audioCtx) audioCtx = new AudioCtxClass(); }

function playClick() {
    ensureAudio();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='sine';
    o.frequency.setValueAtTime(800,audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.06);
    g.gain.setValueAtTime(0.15,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.12);
    o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.12);
}
function playSelect() {
    ensureAudio();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='triangle';
    o.frequency.setValueAtTime(600,audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(900,audioCtx.currentTime+0.08);
    o.frequency.exponentialRampToValueAtTime(1100,audioCtx.currentTime+0.15);
    g.gain.setValueAtTime(0.12,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);
    o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.2);
}
function playSuccess() {
    ensureAudio();
    [523,659,784].forEach((freq,i)=>{
        const o=audioCtx.createOscillator(),g=audioCtx.createGain();
        o.connect(g);g.connect(audioCtx.destination);o.type='sine';
        o.frequency.setValueAtTime(freq,audioCtx.currentTime+i*0.12);
        g.gain.setValueAtTime(0,audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.1,audioCtx.currentTime+i*0.12);
        g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+i*0.12+0.3);
        o.start(audioCtx.currentTime+i*0.12);o.stop(audioCtx.currentTime+i*0.12+0.3);
    });
}
function playWarning() {
    ensureAudio();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);o.type='sawtooth';
    o.frequency.setValueAtTime(300,audioCtx.currentTime);
    o.frequency.linearRampToValueAtTime(200,audioCtx.currentTime+0.3);
    g.gain.setValueAtTime(0.08,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.35);
    o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.35);
}

function createRipple(event,el){
    const r=el.getBoundingClientRect(),s=document.createElement('span');
    s.className='ripple';const sz=Math.max(r.width,r.height);
    s.style.width=s.style.height=sz+'px';
    s.style.left=(event.clientX-r.left-sz/2)+'px';
    s.style.top=(event.clientY-r.top-sz/2)+'px';
    el.appendChild(s);setTimeout(()=>s.remove(),600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MULTIPLAYER - PeerJS Setup
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer = null;
let connection = null;
let isHost = false;
let playerNumber = null;
let playerNames = { 1: 'Player 1', 2: 'Player 2' };
let currentScreen = 'menu'; // menu, lobby, game

// Game Data
const episodeData=[
{id:1,title:"First Night",location:"Toronto Pearson Airport ¬∑ 11:00 PM",description:"You've just cleared customs after a 14-hour flight. Both exhausted and jet-lagged, the airport is quieting down around you. You have two suitcases each and $3,000 in savings. The immediate question: where will you sleep tonight?",timerDuration:30,choices:[{id:'hotel',icon:'üè®',title:'Airport Hotel',cost:'$180',pros:'Immediate rest and comfort',cons:'Expensive, depletes savings'},{id:'airbnb',icon:'üè†',title:'Airbnb (1hr away)',cost:'$125',pros:'More affordable with kitchen',cons:'Late arrival, tired tomorrow'},{id:'relative',icon:'üë®‚Äçüë©‚Äçüëß',title:'Contact Distant Relative',cost:'FREE',pros:'Save money, cultural connection',cons:'Awkward obligation, unknown comfort'}],outcomes:{hotel:{title:'üè® Airport Hotel',description:'You prioritize rest. The room is clean and quiet. You shower and sleep deeply.',money:-180,p1stress:-10,p2stress:-10,relationship:0,trust:0},airbnb:{title:'üè† Airbnb',description:'After a taxi ride, you arrive at a cozy space with a kitchen. Smart choice, though you\'re exhausted.',money:-125,p1stress:5,p2stress:5,relationship:2,trust:2},relative:{title:'üë®‚Äçüë©‚Äçüëß Relative\'s Home',description:'Your relative welcomes you warmly. The space is cramped but you saved money and made a connection.',money:0,p1stress:5,p2stress:5,relationship:5,trust:8}}},
{id:2,title:"Phone Plans",location:"Day 2, Morning ¬∑ Mobile Store",description:"After your first night, you need Canadian phone numbers urgently‚Äîfor job applications, apartment viewings, and staying connected.",timerDuration:30,choices:[{id:'premium',icon:'üì±',title:'Two Premium Plans',cost:'$160',pros:'Unlimited data, excellent coverage',cons:'$80/month ongoing expense'},{id:'budget',icon:'üì≤',title:'Two Budget Plans',cost:'$100',pros:'Affordable at $50/month total',cons:'Limited data (3GB), spotty coverage'},{id:'shared',icon:'‚òéÔ∏è',title:'One Shared Plan',cost:'$80',pros:'Maximum savings',cons:'Logistical nightmare, limits job search'}],outcomes:{premium:{title:'üì± Premium Plans',description:'Two premium plans with unlimited data. You can job search effectively and stay connected with family.',money:-160,p1stress:3,p2stress:-5,relationship:0,trust:2},budget:{title:'üì≤ Budget Plans',description:'Two budget plans at $25 each. Affordable and practical.',money:-100,p1stress:0,p2stress:0,relationship:3,trust:3},shared:{title:'‚òéÔ∏è Shared Plan',description:'One shared number. You saved money but coordinating calls will be challenging.',money:-80,p1stress:10,p2stress:10,relationship:-3,trust:0}}},
{id:3,title:"SIN Registration",location:"Day 3 ¬∑ Service Canada Office",description:"You need a Social Insurance Number (SIN) to work legally in Canada. The Service Canada office has a 2-hour wait.",timerDuration:25,choices:[{id:'together',icon:'ü§ù',title:'Wait Together',cost:'4hrs',pros:'Support each other, bonding time',cons:'Both lose productive time'},{id:'split',icon:'‚ö°',title:'Split Up Tasks',cost:'2hrs',pros:'Efficient, get more done',cons:'One person waits alone'},{id:'reschedule',icon:'üìÖ',title:'Come Back Tomorrow',cost:'0hrs',pros:'Use today productively',cons:'Delays work eligibility'}],outcomes:{together:{title:'ü§ù Wait Together',description:'You spend hours in uncomfortable chairs, but share snacks and talk about your hopes for Canada.',money:0,p1stress:5,p2stress:5,relationship:8,trust:5},split:{title:'‚ö° Split Tasks',description:'Player 1 waits while Player 2 explores the neighborhood. Efficient but lonely.',money:0,p1stress:8,p2stress:-3,relationship:-2,trust:0},reschedule:{title:'üìÖ Rescheduled',description:'You spend the afternoon apartment hunting online instead. Smart but delayed.',money:0,p1stress:-5,p2stress:-5,relationship:2,trust:2}}}
];

let gameState={relationship:70,trust:65,money:3000,p1stress:55,p2stress:50,currentEpisode:1,completedEpisodes:0,episodes:{}};
let timerInterval=null,timeRemaining=30;

// Initialize episodes
episodeData.forEach((ep,i)=>{
    gameState.episodes[ep.id]={p1choice:null,p2choice:null,completed:false,unlocked:i===0};
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QR CODE GENERATION - FIXED VERSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateQRCode() {
    // Wait for DOM and libraries to load
    setTimeout(() => {
        const qrContainer = document.getElementById('qrcode');
        if (!qrContainer || !peer) return;

        // Clear previous QR code
        qrContainer.innerHTML = '';

        // Generate game URL
        const baseUrl = window.location.href.split('?')[0].split('#')[0];
        const gameUrl = `${baseUrl}?join=${peer.id}`;

        console.log('Generating QR code for:', gameUrl);

        // Check if QRCode library is loaded
        if (typeof QRCode === 'undefined') {
            console.error('QRCode library not loaded');
            qrContainer.innerHTML = '<p style="color: #C2410C; padding: 20px;">QR code library failed to load. Use the connection ID below.</p>';
            return;
        }

        try {
            // Create QR code
            new QRCode(qrContainer, {
                text: gameUrl,
                width: 256,
                height: 256,
                colorDark: "#CC785C",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            console.log('QR code generated successfully');
        } catch (error) {
            console.error('QR code generation error:', error);
            qrContainer.innerHTML = '<p style="color: #C2410C; padding: 20px;">Failed to generate QR code. Use the link or ID below.</p>';
        }
    }, 500); // Increased delay to ensure everything is loaded
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
    const app = document.getElementById('app');

    if (currentScreen === 'menu') {
        app.innerHTML = renderMenu();
    } else if (currentScreen === 'lobby') {
        app.innerHTML = renderLobby();
        // Generate QR code after render
        generateQRCode();
    } else if (currentScreen === 'game') {
        app.innerHTML = renderGame();
        setupGameListeners();
    }
}

function renderMenu() {
    return `
        <div class="menu-screen">
            <div class="menu-card">
                <div class="menu-icon">üå±</div>
                <h1 class="menu-title">New Roots</h1>
                <p class="menu-subtitle">Multiplayer Immigration Story Game</p>
                <input type="text" id="player-name-input" class="menu-input" placeholder="Enter your name" value="">
                <button class="menu-btn menu-btn-primary" onclick="hostGame()">üéÆ Host Game</button>
                <button class="menu-btn menu-btn-secondary" onclick="showJoinScreen()">üì± Join Game</button>
                <div id="join-screen" class="hidden" style="margin-top: 20px;">
                    <input type="text" id="join-id-input" class="menu-input" placeholder="Enter Connection ID">
                    <button class="menu-btn menu-btn-primary" onclick="joinGame()">Connect</button>
                    <button class="menu-btn menu-btn-secondary" onclick="hideJoinScreen()">‚Üê Back</button>
                </div>
            </div>
        </div>
    `;
}

function renderLobby() {
    const gameUrl = window.location.href.split('?')[0] + '?join=' + (peer ? peer.id : '');

    return `
        <div class="menu-screen">
            <div class="menu-card">
                <div class="menu-icon">üéÆ</div>
                <h1 class="menu-title">Waiting for Player 2...</h1>
                <p class="menu-subtitle">Share this QR code or connection ID</p>

                <div class="lobby-qr-container">
                    <div id="qrcode"></div>
                </div>

                <div style="margin: 20px 0;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">üì± Share this link:</div>
                    <div class="lobby-url">${gameUrl}</div>
                    <button class="menu-btn menu-btn-secondary" style="margin-top: 8px;" onclick="copyToClipboard('${gameUrl}')">üìã Copy Link</button>
                </div>

                <div style="margin: 20px 0;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">üîë Or share this ID:</div>
                    <div class="lobby-id">${peer ? peer.id : 'Generating...'}</div>
                    <button class="menu-btn menu-btn-secondary" style="margin-top: 8px;" onclick="copyToClipboard('${peer ? peer.id : ''}')">üìã Copy ID</button>
                </div>

                <div class="lobby-players">
                    <div class="lobby-player connected">
                        <div class="lobby-player-icon">üë§</div>
                        <div class="lobby-player-name">${playerNames[1]}</div>
                        <div class="lobby-player-status">Host (You)</div>
                    </div>
                    <div class="lobby-player">
                        <div class="lobby-player-icon">‚è≥</div>
                        <div class="lobby-player-name">Player 2</div>
                        <div class="lobby-player-status">Waiting...</div>
                    </div>
                </div>

                <button class="menu-btn menu-btn-secondary" onclick="cancelHost()">Cancel</button>
            </div>
        </div>
    `;
}

function renderGame() {
    return `
        <header class="header">
            <div class="header-left">
                <div class="logo-icon">üå±</div>
                <div>
                    <div class="game-title">New Roots</div>
                    <div class="chapter-info">Year 1 ¬∑ Chapter 1: The Arrival</div>
                </div>
            </div>
            <div class="connection-status ${isHost ? 'host' : ''}">
                <span class="connection-dot"></span>
                <span>${isHost ? 'Host' : 'Joined'} ¬∑ ${playerNames[playerNumber]}</span>
            </div>
        </header>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: ${(gameState.completedEpisodes/episodeData.length*100)}%"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card" id="stat-relationship">
                <div class="stat-header"><span class="stat-icon">‚ù§Ô∏è</span><span class="stat-label">Relationship</span></div>
                <div class="stat-value" id="relationship-value">${gameState.relationship}</div>
                <div class="stat-bar"><div class="stat-bar-fill relationship" id="relationship-bar" style="width:${gameState.relationship}%"></div></div>
            </div>
            <div class="stat-card" id="stat-trust">
                <div class="stat-header"><span class="stat-icon">ü§ù</span><span class="stat-label">Trust</span></div>
                <div class="stat-value" id="trust-value">${gameState.trust}</div>
                <div class="stat-bar"><div class="stat-bar-fill trust" id="trust-bar" style="width:${gameState.trust}%"></div></div>
            </div>
            <div class="stat-card" id="stat-money">
                <div class="stat-header"><span class="stat-icon">üí∞</span><span class="stat-label">Money</span></div>
                <div class="stat-value" id="money-value">$${gameState.money.toLocaleString()}</div>
            </div>
            <div class="stat-card" id="stat-p1stress">
                <div class="stat-header"><span class="stat-icon">üò∞</span><span class="stat-label">P1 Stress</span></div>
                <div class="stat-value" id="p1stress-value">${gameState.p1stress}</div>
                <div class="stat-bar"><div class="stat-bar-fill stress" id="p1stress-bar" style="width:${gameState.p1stress}%"></div></div>
            </div>
            <div class="stat-card" id="stat-p2stress">
                <div class="stat-header"><span class="stat-icon">üò∞</span><span class="stat-label">P2 Stress</span></div>
                <div class="stat-value" id="p2stress-value">${gameState.p2stress}</div>
                <div class="stat-bar"><div class="stat-bar-fill stress" id="p2stress-bar" style="width:${gameState.p2stress}%"></div></div>
            </div>
        </div>

        <div class="instructions" id="instructions-box">
            <div class="instructions-toggle" onclick="toggleInstructions()">
                <span class="instructions-title">How to Play</span>
                <span class="instructions-arrow" id="instructions-arrow">‚ñº</span>
            </div>
            <div class="instructions-body" id="instructions-body" style="max-height:200px;">
                <ul class="instructions-list">
                    <li>Complete episodes chronicling your first weeks in Canada</li>
                    <li>Each player selects their preferred choice independently</li>
                    <li>If choices differ, negotiate within the time limit</li>
                    <li>Work together to build your new life</li>
                </ul>
            </div>
        </div>

        <nav class="episode-nav" id="episode-nav">
            ${episodeData.map(ep=>`
                <div class="episode-tab ${ep.id===gameState.currentEpisode?'active':''} ${gameState.episodes[ep.id].completed?'completed':''} ${!gameState.episodes[ep.id].unlocked?'locked':''}"
                     id="episode-tab-${ep.id}"
                     onclick="playClick();switchEpisode(${ep.id})">
                    <div class="episode-tab-number">EP ${ep.id}</div>
                    <div class="episode-tab-title">${ep.title}</div>
                </div>`).join('')}
        </nav>

        <div id="episode-containers">
            ${renderEpisode(gameState.currentEpisode)}
        </div>

        <div class="comparison-panel" id="comparison-panel">
            <h2 style="font-size:18px;font-weight:600;margin-bottom:16px;text-align:center;">Your Choices</h2>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <div class="player-avatar" style="margin:0 auto;background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(59,130,246,0.1));">üë§</div>
                    <div style="font-size:12px;color:var(--p1);margin-top:6px;font-weight:600;">${playerNames[1]}</div>
                    <div class="comparison-choice" id="p1-choice-display">‚Äî</div>
                </div>
                <div class="comparison-item">
                    <div class="player-avatar" style="margin:0 auto;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(139,92,246,0.1));">üë§</div>
                    <div style="font-size:12px;color:var(--p2);margin-top:6px;font-weight:600;">${playerNames[2]}</div>
                    <div class="comparison-choice" id="p2-choice-display">‚Äî</div>
                </div>
            </div>
            <div class="match-status" id="match-status"></div>
        </div>

        <div class="negotiation-panel" id="negotiation-panel">
            <div class="negotiation-header">
                <div class="negotiation-title">‚ö†Ô∏è Negotiation Required</div>
                <p style="color:var(--text-light);font-size:14px;">Your preferences differ. Discuss and find common ground.</p>
            </div>
            <div class="timer-display" id="timer">30</div>
            <p style="text-align:center;color:var(--text-light);margin-bottom:16px;font-size:13px;">Select a resolution together:</p>
            <div class="dialogue-grid" id="dialogue-options"></div>
        </div>

        <div class="outcome-panel" id="outcome-panel">
            <div class="outcome-header">
                <div class="outcome-title" id="outcome-title">Decision Made</div>
                <div class="outcome-description" id="outcome-description"></div>
            </div>
            <div class="effects-grid" id="outcome-effects"></div>
            <div class="button-group">
                <button class="btn btn-primary btn-lg" onclick="playClick(); nextEpisode()">Continue ‚Üí</button>
            </div>
        </div>
    `;
}

function renderEpisode(epId) {
    const ep = episodeData.find(e => e.id === epId);
    if (!ep) return '';

    const eps = gameState.episodes[epId];

    return `
        <div class="episode-card">
            <div class="episode-header">
                <div class="episode-number">${ep.id}</div>
                <div class="episode-title">${ep.title}</div>
            </div>
            <div class="scenario-content">
                <div class="scenario-location"><span>üìç</span><span>${ep.location}</span></div>
                <div class="scenario-text">${ep.description}</div>
            </div>
            <div class="players-wrapper">
                <div class="player-section p1-section ${playerNumber === 1 ? 'my-turn' : ''}">
                    <div class="player-header">
                        <div class="player-avatar">üë§</div>
                        <div class="player-name p1">${playerNames[1]}</div>
                    </div>
                    <div class="player-status ${eps.p1choice ? 'chosen' : ''}" id="ep${epId}-p1-status">
                        ${eps.p1choice ? '‚úì Choice made' : playerNumber === 1 ? 'Select your preferred option' : 'Waiting...'}
                    </div>
                    <div class="choices-grid">
                        ${ep.choices.map(c=>choiceHTML(epId,1,c,eps.p1choice===c.id,playerNumber!==1)).join('')}
                    </div>
                </div>
                <div class="player-section p2-section ${playerNumber === 2 ? 'my-turn' : ''}">
                    <div class="player-header">
                        <div class="player-avatar">üë§</div>
                        <div class="player-name p2">${playerNames[2]}</div>
                    </div>
                    <div class="player-status ${eps.p2choice ? 'chosen' : ''}" id="ep${epId}-p2-status">
                        ${eps.p2choice ? '‚úì Choice made' : playerNumber === 2 ? 'Select your preferred option' : 'Waiting...'}
                    </div>
                    <div class="choices-grid">
                        ${ep.choices.map(c=>choiceHTML(epId,2,c,eps.p2choice===c.id,playerNumber!==2)).join('')}
                    </div>
                </div>
            </div>
            <div class="lock-btn-container" id="ep${epId}-lock-btn-container">
                <button class="btn btn-primary btn-lg" id="ep${epId}-lock-btn"
                        onclick="playClick();lockChoices(${epId})"
                        ${eps.p1choice && eps.p2choice ? '' : 'disabled'}>
                    ${eps.p1choice && eps.p2choice ? 'üîí Lock Choices' : '‚è≥ Waiting for both players...'}
                </button>
            </div>
        </div>
    `;
}

function choiceHTML(epId,player,c,selected,disabled){
    return `<div class="choice-card ${selected?'selected':''} ${disabled?'disabled':''}"
                 data-episode="${epId}" data-player="${player}" data-choice="${c.id}">
        <div class="choice-header">
            <div class="choice-title"><span>${c.icon}</span><span>${c.title}</span></div>
            <div class="choice-cost">${c.cost}</div>
        </div>
        <div class="choice-details">
            <div class="choice-detail pro"><span>‚úì</span><span>${c.pros}</span></div>
            <div class="choice-detail con"><span>‚úó</span><span>${c.cons}</span></div>
        </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleInstructions(){
    const body = document.getElementById('instructions-body');
    const arrow = document.getElementById('instructions-arrow');
    if (body.style.maxHeight === '0px') {
        body.style.maxHeight = '200px';
        arrow.classList.remove('open');
    } else {
        body.style.maxHeight = '0px';
        arrow.classList.add('open');
    }
}

function setupGameListeners(){
    document.querySelectorAll('.choice-card:not(.disabled)').forEach(card=>{
        card.addEventListener('click',function(e){
            if (this.classList.contains('disabled')) return;
            createRipple(e,this);
            playSelect();
            selectChoice(parseInt(this.dataset.episode),parseInt(this.dataset.player),this.dataset.choice);
        });
    });
}

function selectChoice(episode,player,choice){
    if (player !== playerNumber) return;

    const ep=episodeData.find(e=>e.id===episode);
    const cd=ep.choices.find(c=>c.id===choice);
    gameState.episodes[episode][`p${player}choice`]=choice;

    if (connection && connection.open) {
        sendData({
            type: 'choice',
            episode: episode,
            player: player,
            choice: choice
        });
    }

    currentScreen = 'game';
    render();
    playSelect();
}

function lockChoices(epId){
    const eps=gameState.episodes[epId];
    if (!eps.p1choice || !eps.p2choice) return;

    const ep=episodeData.find(e=>e.id===epId);
    const p1c=ep.choices.find(c=>c.id===eps.p1choice);
    const p2c=ep.choices.find(c=>c.id===eps.p2choice);

    document.getElementById('p1-choice-display').textContent=`${p1c.icon} ${p1c.title}`;
    document.getElementById('p2-choice-display').textContent=`${p2c.icon} ${p2c.title}`;
    document.getElementById('comparison-panel').classList.add('active');
    document.getElementById(`ep${epId}-lock-btn-container`).classList.add('hidden');

    if(eps.p1choice===eps.p2choice){
        playSuccess();
        document.getElementById('match-status').className='match-status success';
        document.getElementById('match-status').textContent='‚úì Perfect alignment! You chose the same option.';
        setTimeout(()=>processOutcome(epId,eps.p1choice,'agreement'),2000);
    }else{
        playWarning();
        document.getElementById('match-status').className='match-status warning';
        document.getElementById('match-status').textContent='‚ö†Ô∏è Different choices‚Äîtime to negotiate.';
        setTimeout(()=>startNegotiation(epId),2000);
    }
}

function startNegotiation(epId){
    const ep=episodeData.find(e=>e.id===epId);
    document.getElementById('negotiation-panel').classList.add('active');
    const dg=ep.choices.map(c=>({text:`"${c.title} makes sense. Let's go with that."`,result:c.id}));
    dg.push({text:'"I feel strongly. Trust me on this."',result:'insist'});
    document.getElementById('dialogue-options').innerHTML=dg.map(d=>
        `<div class="dialogue-option" onclick="playClick();negotiate(${epId},'${d.result}');">üí¨ ${d.text}</div>`).join('');
    timeRemaining=ep.timerDuration;
    updateTimer();
    timerInterval=setInterval(()=>{
        timeRemaining--;
        updateTimer();
        if(timeRemaining<=0){
            clearInterval(timerInterval);
            negotiate(epId,'timeout');
        }
    },1000);
}

function updateTimer(){
    const el=document.getElementById('timer');
    if (el) {
        el.textContent=timeRemaining;
        el.classList.toggle('critical',timeRemaining<=10);
    }
}

function negotiate(epId,method){
    if(timerInterval)clearInterval(timerInterval);
    const eps=gameState.episodes[epId],ep=episodeData.find(e=>e.id===epId);
    let fc;
    if(method==='insist')fc=Math.random()>0.5?eps.p1choice:eps.p2choice;
    else if(method==='timeout')fc=ep.choices[1].id;
    else fc=method;

    if (connection && connection.open) {
        sendData({
            type: 'negotiation',
            episode: epId,
            finalChoice: fc,
            method: method
        });
    }

    processOutcome(epId,fc,method);
}

function processOutcome(epId,choice,method){
    document.getElementById('negotiation-panel').classList.remove('active');
    document.getElementById('comparison-panel').classList.remove('active');

    const ep=episodeData.find(e=>e.id===epId),o=ep.outcomes[choice],eps=gameState.episodes[epId];
    gameState.money+=o.money;
    gameState.p1stress=clamp(gameState.p1stress+(method==='agreement'?o.p1stress:(eps.p1choice===choice?o.p1stress:-o.p1stress)));
    gameState.p2stress=clamp(gameState.p2stress+(method==='agreement'?o.p2stress:(eps.p2choice===choice?o.p2stress:-o.p2stress)));
    gameState.relationship=clamp(gameState.relationship+(method==='agreement'?o.relationship+5:method==='timeout'?-10:o.relationship));
    gameState.trust=clamp(gameState.trust+(method==='agreement'?o.trust+5:method==='timeout'?-10:o.trust));

    document.getElementById('outcome-title').textContent=o.title;
    document.getElementById('outcome-description').textContent=method==='timeout'?'Time ran out. A rushed decision was made. Both feel frustrated.':o.description;

    const fx=[];
    if(o.money!==0)fx.push({type:'neutral',icon:'üí∞',text:`Money ${o.money>0?'+':''}$${Math.abs(o.money)} (Total: $${gameState.money.toLocaleString()})`});
    const rc=method==='agreement'?o.relationship+5:(method==='timeout'?-10:o.relationship);
    if(rc!==0)fx.push({type:rc>0?'positive':'negative',icon:'‚ù§Ô∏è',text:`Relationship ${rc>0?'+':''}${rc} (Now: ${gameState.relationship})`});
    const tc=method==='agreement'?o.trust+5:(method==='timeout'?-10:o.trust);
    if(tc!==0)fx.push({type:tc>0?'positive':'negative',icon:'ü§ù',text:`Trust ${tc>0?'+':''}${tc} (Now: ${gameState.trust})`});
    if(method==='agreement')fx.push({type:'positive',icon:'‚ú®',text:'Perfect communication bonus!'});
    if(method==='timeout')fx.push({type:'negative',icon:'‚ö†Ô∏è',text:'Communication breakdown penalty'});

    document.getElementById('outcome-effects').innerHTML=fx.map(e=>`<div class="effect-item ${e.type}"><span>${e.icon}</span><span>${e.text}</span></div>`).join('');

    updateStats();
    document.getElementById('outcome-panel').classList.add('active');
    document.getElementById('outcome-panel').scrollIntoView({behavior:'smooth',block:'center'});

    eps.completed=true;
    gameState.completedEpisodes++;

    if(epId<episodeData.length){
        gameState.episodes[epId+1].unlocked=true;
    }

    updateProgress();
    playSuccess();

    if (connection && connection.open) {
        sendData({
            type: 'gameState',
            state: gameState
        });
    }
}

function clamp(v){return Math.max(0,Math.min(100,v));}

function updateStats(){
    ['relationship','trust','p1stress','p2stress'].forEach(u=>{
        const val = document.getElementById(`${u}-value`);
        const bar = document.getElementById(`${u}-bar`);
        if (val) val.textContent=gameState[u];
        if (bar) bar.style.width=gameState[u]+'%';
    });
    const money = document.getElementById('money-value');
    if (money) money.textContent='$'+gameState.money.toLocaleString();
}

function updateProgress(){
    const fill = document.getElementById('progress-fill');
    if (fill) fill.style.width=(gameState.completedEpisodes/episodeData.length*100)+'%';
}

function switchEpisode(epId){
    if(!gameState.episodes[epId]||!gameState.episodes[epId].unlocked)return;
    gameState.currentEpisode=epId;
    ['outcome-panel','comparison-panel','negotiation-panel'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
    });
    render();
}

function nextEpisode(){
    if(gameState.currentEpisode<episodeData.length){
        switchEpisode(gameState.currentEpisode+1);
        window.scrollTo({top:0,behavior:'smooth'});
    }
    else showFinalSummary();
}

function showFinalSummary(){
    const s=gameState;
    const rs=s.relationship>=80?'Thriving':s.relationship>=60?'Strong':s.relationship>=40?'Stable':'Strained';
    const ms=s.money>=2000?'Financially Secure':s.money>=1000?'Managing':s.money>=0?'Struggling':'In Debt';
    const rb=s.relationship>=60?'badge-great':s.relationship>=40?'badge-ok':'badge-bad';
    const mb=s.money>=1000?'badge-great':s.money>=0?'badge-ok':'badge-bad';

    document.getElementById('final-modal-content').innerHTML=`
        <h2>üéÆ Chapter 1 Complete</h2>
        <p class="subtitle">You've survived your first weeks in Canada!</p>
        <div class="final-stat"><span class="final-stat-label">‚ù§Ô∏è Relationship</span><span class="final-stat-value">${s.relationship} <span class="final-badge ${rb}">${rs}</span></span></div>
        <div class="final-stat"><span class="final-stat-label">ü§ù Trust</span><span class="final-stat-value">${s.trust}</span></div>
        <div class="final-stat"><span class="final-stat-label">üí∞ Money</span><span class="final-stat-value">$${s.money.toLocaleString()} <span class="final-badge ${mb}">${ms}</span></span></div>
        <div class="final-stat"><span class="final-stat-label">üò∞ P1 Stress</span><span class="final-stat-value">${s.p1stress}</span></div>
        <div class="final-stat"><span class="final-stat-label">üò∞ P2 Stress</span><span class="final-stat-value">${s.p2stress}</span></div>
        <div class="chapter-preview"><strong>Coming in Chapter 2:</strong> First month of work, making friends, cultural adaptation, career advancement, and building your new life.</div>
        <button class="btn btn-primary" onclick="playClick();document.getElementById('final-modal').classList.remove('active');">Close</button>`;

    document.getElementById('final-modal').classList.add('active');
    playSuccess();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MULTIPLAYER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initPeer() {
    peer = new Peer({
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        }
    });

    peer.on('open', (id) => {
        console.log('My peer ID is: ' + id);

        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get('join');
        if (joinId && !isHost) {
            setTimeout(() => {
                const joinInput = document.getElementById('join-id-input');
                if (joinInput) {
                    joinInput.value = joinId;
                }
                showJoinScreen();
            }, 100);
        }
    });

    peer.on('connection', (conn) => {
        console.log('Incoming connection');
        connection = conn;
        setupConnection();
    });

    peer.on('error', (err) => {
        console.error('Peer error:', err);
        alert('Connection error: ' + err.message);
    });
}

function setupConnection() {
    connection.on('open', () => {
        console.log('Connection established');
        playSuccess();

        if (isHost) {
            sendData({
                type: 'init',
                playerNames: playerNames,
                gameState: gameState
            });
            currentScreen = 'game';
            render();
        }
    });

    connection.on('data', (data) => {
        console.log('Received:', data);
        handleReceivedData(data);
    });

    connection.on('close', () => {
        alert('Connection closed');
        window.location.reload();
    });

    connection.on('error', (err) => {
        console.error('Connection error:', err);
    });
}

function sendData(data) {
    if (connection && connection.open) {
        connection.send(data);
    }
}

function handleReceivedData(data) {
    switch (data.type) {
        case 'init':
            playerNames = data.playerNames;
            gameState = data.gameState;
            currentScreen = 'game';
            render();
            break;

        case 'name':
            playerNames = data.playerNames;
            if (currentScreen === 'lobby') {
                render();
            }
            break;

        case 'choice':
            gameState.episodes[data.episode][`p${data.player}choice`] = data.choice;
            if (currentScreen === 'game') {
                render();
            }
            break;

        case 'negotiation':
            if (timerInterval) clearInterval(timerInterval);
            processOutcome(data.episode, data.finalChoice, data.method);
            break;

        case 'gameState':
            gameState = data.state;
            updateStats();
            updateProgress();
            break;
    }
}

function hostGame() {
    const nameInput = document.getElementById('player-name-input');
    if (!nameInput.value.trim()) {
        alert('Please enter your name');
        return;
    }

    playClick();
    isHost = true;
    playerNumber = 1;
    playerNames[1] = nameInput.value.trim();

    if (!peer) initPeer();

    currentScreen = 'lobby';
    render();
}

function showJoinScreen() {
    playClick();
    document.getElementById('join-screen').classList.remove('hidden');
}

function hideJoinScreen() {
    playClick();
    document.getElementById('join-screen').classList.add('hidden');
}

function joinGame() {
    const nameInput = document.getElementById('player-name-input');
    const joinInput = document.getElementById('join-id-input');

    if (!nameInput.value.trim()) {
        alert('Please enter your name');
        return;
    }

    if (!joinInput.value.trim()) {
        alert('Please enter connection ID');
        return;
    }

    playClick();
    isHost = false;
    playerNumber = 2;
    playerNames[2] = nameInput.value.trim();

    if (!peer) initPeer();

    setTimeout(() => {
        connection = peer.connect(joinInput.value.trim());
        setupConnection();

        connection.on('open', () => {
            sendData({
                type: 'name',
                playerNames: playerNames
            });
        });
    }, 1000);
}

function cancelHost() {
    playClick();
    if (peer) peer.destroy();
    window.location.reload();
}

function copyToClipboard(text) {
    if (!text) {
        alert('Nothing to copy yet. Please wait for connection ID to generate.');
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        playClick();
        alert('‚úì Copied to clipboard!');
    }).catch(() => {
        alert('Failed to copy. Please copy manually.');
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
    render();
});
</script>
</body>
</html>